# Скрипт для создания и управления QEMU/KVM виртуальными машинами

Этот проект представляет собой интерактивный Bash-скрипт (`install.sh`), который автоматизирует процесс создания, настройки и запуска виртуальных машин (ВМ) с использованием QEMU/KVM. Скрипт генерирует портативные и удобные в использовании файлы для установки и последующего запуска ВМ.

## Основные возможности

*   **Интерактивная настройка:** Скрипт задает вопросы о параметрах ВМ (CPU, RAM, размер диска).
*   **Гибкий выбор компонентов:** Позволяет выбрать тип прошивки (BIOS/UEFI), контроллера диска и сетевого адаптера для лучшей производительности или совместимости.
*   **Автоматизация:** Скачивает необходимые драйверы VirtIO для Windows.
*   **Портативность:** Генерирует "умный" скрипт запуска (`start.sh`), который автоматически определяет пути к файлам ВМ. Это позволяет легко копировать и перемещать директорию с ВМ.
*   **Удобное управление:** Сгенерированный `start.sh` запускает и ВМ, и SPICE-клиент (`remote-viewer`) одной командой, а также корректно завершает оба процесса по `Ctrl+C`.

## Установка зависимостей

Для полноценной работы скрипта необходимо установить QEMU/KVM, прошивку OVMF (для UEFI) и SPICE-клиент.

#### Для Arch Linux и его производных:
```bash
sudo pacman -S qemu-full edk2-ovmf virt-viewer
```

#### Для Debian, Ubuntu и их производных:
```bash
sudo apt update
sudo apt install qemu-system-x86 qemu-utils ovmf virt-viewer
```

## Как использовать

1.  **Расположите скрипт рядом с вашими ISO-образами:**
    ```bash
    $ ls -a
    .
    ..
    install.sh
    linuxmint.iso
    windows.iso
    ```
2.  **Сделайте скрипт исполняемым:**
    ```bash
    chmod +x install.sh
    ```
3.  **Запустите скрипт:**
    ```bash
    ./install.sh
    ```
4.  **Ответьте на вопросы** для конфигурации вашей будущей ВМ.
5.  Скрипт создаст директорию `./vms/имя_вашей_вм/` и автоматически запустит процесс установки операционной системы.
6.  После завершения установки для запуска ВМ используйте команду:
    ```bash
    cd ./vms/имя_вашей_вм/
    ./start.sh
    ```

## Объяснение опций при настройке

Скрипт предлагает несколько ключевых выборов, которые влияют на производительность и совместимость ВМ.

#### 1. Использовать UEFI (OVMF) вместо BIOS?
*   **Нет (обычный BIOS)** (по умолчанию): Классический вариант, совместимый с большинством старых и многих современных ОС. Идеально подходит для большинства дистрибутивов Linux и Windows 10.
*   **Да (UEFI)**: Современный стандарт прошивки. **Обязателен для установки Windows 11** и некоторых современных дистрибутивов Linux в режиме UEFI.

#### 2. Выберите тип контроллера диска
*   **Virtio (для Linux, самый быстрый)** (по умолчанию): Обеспечивает максимальную производительность диска за счет паравиртуализации. Драйверы встроены в ядро Linux, поэтому для Linux-систем это лучший выбор.
*   **IDE**: Эмуляция старого, но универсального контроллера. Скорость ниже, но совместимость максимальная. Используйте для очень старых ОС (например, Windows XP).
*   **Virtio (для Windows)**: Тот же быстрый контроллер, но требует **ручной установки драйвера** во время установки Windows (см. инструкцию ниже).

#### 3. Выберите сетевой адаптер
*   **Virtio** (по умолчанию): Самый быстрый сетевой адаптер. Требует установки драйвера в Windows (обычно с того же диска `virtio-win.iso`).
*   **E1000**: Эмуляция популярной сетевой карты Intel. Скорость ниже, но драйверы встроены в большинство ОС, включая Windows, что упрощает установку.


#### 4. Рекомендации по выбору опций
*   Для Linux-дистрибутивов выбирайте все опции по-умолчанию: **1, 1, 1**
*   Для Windows 10/11: **2, 3, 2**

---

## Руководство по установке для Windows

При использовании VirtIO-компонентов (диск, сеть, видео) для максимальной производительности требуется установка драйверов внутри гостевой Windows. Скрипт `start.sh` автоматически подключает ISO-образ `virtio-win.iso` как CD-дисковод для этих целей.

### 0. Загрузка установщика

При запуске QEMU, он предложит нажать на любую кнопку, чтобы загрузиться с CD, и сделает это несколько раз: первый раз для CD с установщиком, второй - для CD с `virtio-win.iso`. Вам надо успеть нажать на любую клавишу в первый раз - сразу после запуска QEMU.

Если проигнорировать эти сообщения, загрузка продолжится с `qcow2` диска (полезно, когда установщик предложит перезагрузить систему).

### 1. Установка драйвера диска (во время установки Windows)

Если вы выбрали **"Virtio (для Windows)"** в качестве контроллера диска, на этапе выбора диска для установки вы увидите пустой список.

1.  Нажмите **"Загрузить драйвер"** (Load driver).
2.  Нажмите **"Обзор"** (Browse).
3.  Выберите CD-дисковод с именем `virtio-win...`.
4.  Перейдите в папку `amd64` -> `w10`.
5.  Нажмите **"ОК"**. Драйвер `Red Hat VirtIO SCSI controller` будет найден.
6.  Нажмите **"Далее"**. Ваш виртуальный диск появится в списке, и вы сможете продолжить установку.

#### 2. Инструкция по обходу проверки TPM и Secure Boot для Windows 11

На том самом экране, где вы видите ошибку, сделайте следующее:

1.  Нажмите на клавиатуре комбинацию клавиш **`Shift + F10`**. Появится черное окно командной строки.
2.  В этом окне введите команду `regedit` и нажмите `Enter`. Откроется Редактор реестра.
3.  В левой панели редактора реестра перейдите по пути:
    `HKEY_LOCAL_MACHINE\SYSTEM\Setup`
4.  Нажмите правой кнопкой мыши на папке (ключе) `Setup`, выберите **Создать (New)** -> **Раздел (Key)**.
5.  Назовите новый раздел `LabConfig` и нажмите `Enter`.
6.  Теперь нажмите на созданный раздел `LabConfig` (чтобы он был выделен). В правой части окна нажмите правой кнопкой мыши на пустом месте и выберите **Создать (New)** -> **Параметр DWORD (32-бит)**.
7.  Назовите этот параметр `BypassTPMCheck` и нажмите `Enter`.
8.  Создайте еще один такой же параметр (**DWORD 32-бит**) и назовите его `BypassSecureBootCheck`.
9.  Теперь дважды щелкните по `BypassTPMCheck`, в поле **"Значение" (Value data)** введите цифру `1` и нажмите "ОК".
10. Сделайте то же самое для `BypassSecureBootCheck`: дважды щелкните, введите `1` в поле "Значение" и нажмите "ОК".  
11. Закройте Редактор реестра и окно командной строки.
12. В окне установщика Windows **нажмите на синюю стрелку "Назад"** в левом верхнем углу.
13. Вы вернетесь к выбору редакции Windows. Снова нажмите **"Далее"**.

На этот раз проверка пройдет успешно, и вы сможете продолжить установку как обычно, включая этап с загрузкой драйвера для VirtIO-диска.

### 3. Работа под локальной учетной записью Windows 11

Если вы не хотите использовать учетную запись Microsoft для входа в систему:

1.  Нажмите на клавиатуре комбинацию клавиш **`Shift + F10`**. Появится черное окно командной строки.
2.  В этом окне введите команду `start ms-cxh:localonly` и нажмите `Enter`. 
3.  Откроется окно, в необходимо придумать имя логина и пароль, после чего нажать **"Далее"**.

### 4. Установка видеодрайвера и гостевых утилит (после установки Windows)

После установки Windows вы заметите, что выбор разрешений экрана ограничен.

1.  Запустите ВМ и войдите в систему.
2.  Откройте **Диспетчер устройств** (Win+X -> Диспетчер устройств).
3.  Найдите **"Видеоадаптеры"** -> "Базовый видеоадаптер Майкрософт".
4.  Нажмите на него правой кнопкой -> **"Обновить драйвер"** -> "Найти драйверы на этом компьютере".
5.  Нажмите **"Обзор"** и выберите CD-дисковод `virtio-win`. Убедитесь, что галочка "Включая вложенные папки" стоит. Нажмите **"Далее"**. Драйвер **QXL** будет установлен автоматически.
6.  После этого откройте CD-дисковод `virtio-win` в "Этом компьютере" и запустите файл `virtio-win-guest-tools.exe`. Это установит гостевые службы SPICE для лучшей интеграции (общий буфер обмена, автоматическое изменение разрешения окна).

---

## Клонирование (создание дубликата) ВМ

Благодаря портативности, созданной скриптом, клонировать ВМ очень просто.

1.  **Скопируйте директорию** с уже установленной ВМ:
    ```bash
    cp -r ./vms/win10 ./vms/win10-clone
    ```
2.  Перейдите в новую директорию:
    ```bash
    cd ./vms/win10-clone
    ```
3.  **Отредактируйте `start.sh`**. Скрипт автоматически определяет имя директории и использует его как имя ВМ и имя файла диска (`.qcow2`). Чтобы не переименовывать файлы внутри клонированной папки, надо изменить значение переменной `VM_NAME` на название виртуальной машины, ИЗ КОТОРОЙ вы делает клон. 
Найдите эту строку в `start.sh`:
    ```bash
    VM_NAME=$(basename "$VM_DIR")
    ```
    И замените ее на имя старой VM:
    ```bash
    VM_NAME=win10
    ```
4.  Запустите новую ВМ:
    ```bash
    ./start.sh
    ```
